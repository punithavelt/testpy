
pipeline {
    agent any
    
    options {
        skipDefaultCheckout(true) 
    }
    
    environment {
        MAILTEMPLATE = '' // Define MAILTEMPLATE variable
       
     }

    stages {
        stage('Initialization') {
            steps {
                cleanWs()
            }
        }
        stage('Fetch Scripts') {
            steps {
                // Clone the "scripts" Git repository
                git branch: 'main', url: 'https://github.com/punithavelt/testpy.git'
                script {
                    // Define the absolute path to the file or use workspace
                    def file = new File("${workspace}/mailtemplate.html")
                    def htmlContent = file.text
                    
                 //   htmlContent = htmlContent.replaceAll("[RECIEVER_NAME]", 'himachal')
                 //   htmlContent = htmlContent.replaceAll("[JOBNAME]", 'himachal')
                    echo "BUILD_URL: ${BUILD_URL}"
                    def approvalUrl = currentBuild.absoluteUrl + 'input/'
                    echo "Approval URL: ${approvalUrl}"
                     MAILTEMPLATE = htmlContent // Overwrite MAILID for validation
                    emailext body: MAILTEMPLATE, subject: 'Approval Request ${JOB_NAME}', to: 'tech@thestagings.com'
                  }
                
            }
        }
        stage('Fetch Release Notes') {
            steps {
                sh "pwd"
                sh "ls"
                // Clone the "scripts" Git repository
              //  git branch: 'master', credentialsId: 'RELEASENOTE2', url: 'ssh://gitolite@34.80.74.159/leykart-release-notes'
               
            }
        }
         stage('Approval 1') {
            steps {
               
                 
            //  sh "pwd"
             //   sh "ls"
               
              //  echo "I am approval 1"
             //    echo "${MAILTEMPLATE}"
                // Access release notes and scripts from the shared location
                // Perform actions or checks specific to Approval 1
                
                
                 script {
                    // Pause the pipeline and prompt for approval
                    def userInput = input(
                        id: 'userInput',
                        message: 'Do you approve this deployment?',
                         parameters: [
                            booleanParam(name: 'Comments', defaultValue: false, description: 'Approve or reject?')
                        ]
                    )
                    
                    // Check if user approved
                    if (userInput) {
                        echo 'Deployment approved!'
                        // Proceed with deployment logic
                    } else {
                        error 'Deployment rejected!'
                    }
                }
                
                
            }
        }
        
        
       
        stage('Approval 2') {
            steps {
                timeout(time: 10, unit: 'MINUTES') { // Set a maximum duration for the pipeline execution
                    script {
                        boolean approvalReceived = false
                        while (!approvalReceived) {
                            def approvalResponse = sh(script: 'python3 readmail.py', returnStdout: true).trim()
                            if (approvalResponse == 'OK') {
                                approvalReceived = true
                              //  build job: 'Name_of_Your_Other_Job', parameters: [
                              //      string(name: 'PARAMETER_NAME', value: 'PARAMETER_VALUE')
                                    // Add more parameters if needed
                              //  ]
                            } else if (approvalResponse == 'REJECT') {
                                approvalReceived = true
                                echo 'Approval rejected. Deployment halted.'
                            } else {
                                echo 'No response yet. Waiting...'
                                sleep 60 // Wait for 5 minutes before checking again
                            }
                        }
                    }
                }
            }
        }
        stage('Approval 3') {
            steps {
                sh "pwd"
                  sh "ls"
                echo "I am approval "
                 // Access release notes and scripts from the shared location
                // Perform actions or checks specific to Approval 3
            }
        }
        stage('Deploy Code') {
            steps {
          //      sh "pwd"
            //      sh "ls"
              echo "I am Deploy Code. Final step"
                // Access release notes and scripts from the shared location
                // Perform code deployment using scripts or commands from the repository
            }
        }
    }
}
